# SaaS migrations playbook

Эти шаги помогают перевести уже работающую инсталляцию из однопользовательского режима к многотенантной модели с организациями.

## 1. Подготовить Default-организацию
1. Создайте запись `organizations` c понятным именем, например `Default`. Теперь рекомендуемый `org_id` фиксирован и равен `00000000-0000-0000-0000-000000000001` (миграции `0034_org_id_uuid_and_default_org` и `0035_org_id_core_tables` гарантируют её наличие и создают плейсхолдер для биллинга).
2. Для существующих администраторов создайте `users` и `memberships`, выдав роли `owner/admin/dispatcher/finance` по необходимости.
3. Обновите переменные окружения, чтобы новые токены JWT содержали `org_id` и совпадали с созданными пользователями. Для SaaS-запросов `org_id` обязателен — не полагайтесь на silent fallback.

## 2. Привязать существующие данные к org_id
1. Остановите приложение и сделайте бэкап базы данных.
2. Примените миграцию `0035_org_id_core_tables`: она добавляет `org_id` (UUID) во все ключевые бизнес-таблицы (teams, bookings, leads, invoices, workers, documents, photos, payments, subscriptions, disputes, admin audit logs, export events, email events), backfill'ит их значением `DEFAULT_ORG_ID`, создаёт внешние ключи на `organizations` и делает столбец NOT NULL.
3. Создайте индексы по `org_id` для таблиц с основными запросами (bookings, invoices, workers и т.д.). В `0035` уже добавлены индексы `org_id` и полезные составные варианты (`org_id, status`, `org_id, created_at`, `org_id, starts_at`).
4. Если применимы внешние ключи, настройте их на `organizations.org_id`. Миграции `0034` и `0035` покрывают стандартные случаи.
5. Миграция `0034` переводит SaaS-таблицы (`organization_billing`, `organization_usage_events`) на UUID-тип и пересобирает внешние ключи.

## 3. Прогнать миграции и проверить запросы
1. Выполните `alembic upgrade head` после обновления кода (см. runbook ниже для пошагового применения `0035`).
2. Проверьте, что все API-приложения добавляют `org_id` в создаваемые записи и фильтруют выборки по нему. Новые столбцы не имеют server_default — вставки без `org_id` должны считаться ошибкой.
3. Убедитесь, что публичные токены (инвойсы, ссылки) учитывают `org_id` и не пересекаются между организациями.

## 4. Smoke-тест
1. Выполните быстрый сценарий: войти как админ, создать заказ, выставить инвойс и оплатить его в рамках новой организации.
2. Создайте вторую организацию и убедитесь, что данные первой не видны ни в админке, ни в воркер-портале.
3. Запустите `pytest -q`, чтобы проверить автоматические тесты из репозитория.

## 5. Роллбек-план
- Если миграция прошла неуспешно, восстановите БД из бэкапа.
- Проверьте, что конфигурация окружения указывает на правильные org_id и секреты JWT.
- Для `0035_org_id_core_tables` downgrade удаляет столбцы и индексы `org_id`, но не трогает существующую запись Default-организации.

## Примечания
- Не изменяйте `package.json` и `package-lock.json` в рамках миграции.
- Публичный UI инвойсов остаётся на английском, даже после включения новых организаций.

TODO: добавить `org_id` в основные бизнес-таблицы (teams, bookings, invoices, workers, photos) и обеспечить фильтрацию запросов по организации.

## Runbook: безопасное применение `0035_org_id_core_tables` в проде
1. **Подготовка.** Убедитесь, что `DEFAULT_ORG_ID=00000000-0000-0000-0000-000000000001` прописан в переменных окружения и что такой `org_id` существует (миграции 0034/0035 создают его при необходимости).
2. **Бэкап.** Сделайте снапшот БД/pg_dump перед началом.
3. **Стейджинг.** Прогоните `alembic upgrade 0035` на стенде с копией данных и проверьте выборку по основным таблицам (bookings, invoices, workers, leads) с фильтрацией по `org_id`.
4. **Прод.** Выполните `alembic upgrade 0035` → убедитесь, что индексы `ix_*org*` созданы: `\di *org*` в psql или `SELECT indexname FROM pg_indexes WHERE indexname LIKE '%org%' AND schemaname = 'public';`.
5. **Smoke-тест.** Создайте заказ, счет, оплату и email-уведомление внутри выбранной организации; убедитесь, что новые строки получили корректный `org_id` и доступны только при фильтре по нему.
6. **Роллбек (при необходимости).** Выполните `alembic downgrade 0034` и откатите приложение. Если данные уже начали писаться с `org_id`, используйте бэкап для восстановления целостности.
