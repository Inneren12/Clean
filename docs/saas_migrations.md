# SaaS migrations playbook

Эти шаги помогают перевести уже работающую инсталляцию из однопользовательского режима к многотенантной модели с организациями.

## 1. Подготовить Default-организацию
1. Создайте запись `organizations` c понятным именем, например `Default`.
2. Для существующих администраторов создайте `users` и `memberships`, выдав роли `owner/admin/dispatcher/finance` по необходимости.
3. Обновите переменные окружения, чтобы новые токены JWT содержали `org_id` и совпадали с созданными пользователями.

## 2. Привязать существующие данные к org_id
1. Остановите приложение и сделайте бэкап базы данных.
2. Для каждой бизнес-таблицы добавьте столбец `org_id` (UUID), установите значение `Default`-организации для всех текущих строк.
3. Создайте индексы по `org_id` для таблиц с основными запросами (bookings, invoices, workers и т.д.).
4. Если применимы внешние ключи, настройте их на `organizations.org_id`.

## 3. Прогнать миграции и проверить запросы
1. Выполните `alembic upgrade head` после обновления кода.
2. Проверьте, что все API-приложения добавляют `org_id` в создаваемые записи и фильтруют выборки по нему.
3. Убедитесь, что публичные токены (инвойсы, ссылки) учитывают `org_id` и не пересекаются между организациями.

## 4. Smoke-тест
1. Выполните быстрый сценарий: войти как админ, создать заказ, выставить инвойс и оплатить его в рамках новой организации.
2. Создайте вторую организацию и убедитесь, что данные первой не видны ни в админке, ни в воркер-портале.
3. Запустите `pytest -q`, чтобы проверить автоматические тесты из репозитория.

## 5. Роллбек-план
- Если миграция прошла неуспешно, восстановите БД из бэкапа.
- Проверьте, что конфигурация окружения указывает на правильные org_id и секреты JWT.

## Примечания
- Не изменяйте `package.json` и `package-lock.json` в рамках миграции.
- Публичный UI инвойсов остаётся на английском, даже после включения новых организаций.
